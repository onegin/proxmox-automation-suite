#!/bin/bash

# üéØ –°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Samba Active Directory Domain Controller –Ω–∞ Debian
# 
# üë®‚Äçüíª –ê–≤—Ç–æ—Ä: –ê–Ω—Ç–æ–Ω–æ–≤ –ï–≤–≥–µ–Ω–∏–π
# üìß –ö–æ–Ω—Ç–∞–∫—Ç—ã: ae@dcea.ru
# 
# ======================================================================

# üìù –û–ø–∏—Å–∞–Ω–∏–µ: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –¥–æ–º–µ–Ω–∞ –Ω–∞ –±–∞–∑–µ Samba4

# üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [ "$EUID" -ne 0 ]; then
    echo "‚ùå –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤–∞ root. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: sudo $0"
    exit 1
fi

echo "üéâ –ù–∞—á–∏–Ω–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É Samba Active Directory Domain Controller"
echo "==============================================================="

# üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ –∏ —Å–∏—Å—Ç–µ–º—ã..."
apt update && apt upgrade -y

# üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤..."
apt install -y samba smbclient winbind krb5-user dnsutils

# üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–ª—É–∂–±
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–ª—É–∂–± Samba..."
systemctl stop samba-ad-dc 2>/dev/null
systemctl stop smbd 2>/dev/null  
systemctl stop nmbd 2>/dev/null
systemctl stop winbind 2>/dev/null
systemctl disable smbd nmbd winbind 2>/dev/null

# üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—á–∏—Å—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
if [ -f "/etc/samba/smb.conf" ]; then
    backup_name="/etc/samba/smb.conf.bak.$(date +%Y%m%d%H%M%S)"
    cp /etc/samba/smb.conf "$backup_name"
    echo "üìÇ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è smb.conf —Å–æ–∑–¥–∞–Ω–∞: $backup_name"
    rm -f /etc/samba/smb.conf
fi

# üóëÔ∏è –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö Samba
if [ -d "/var/lib/samba" ]; then
    backup_dir="/var/lib/samba.bak.$(date +%Y%m%d%H%M%S)"
    mv /var/lib/samba "$backup_dir"
    echo "üìÇ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –¥–∞–Ω–Ω—ã—Ö Samba —Å–æ–∑–¥–∞–Ω–∞: $backup_dir"
fi

# üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —á–∏—Å—Ç–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–ª—è Samba
mkdir -p /var/lib/samba
chmod 755 /var/lib/samba

# üìù –í–≤–æ–¥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–æ–º–µ–Ω–∞
echo ""
echo "üìù –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–º–µ–Ω–∞:"
echo "============================"
echo "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–æ–º–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, example.local):"
read DOMAIN
echo "–í–≤–µ–¥–∏—Ç–µ NetBIOS-–∏–º—è –¥–æ–º–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, EXAMPLE):"
read NETBIOS_NAME
echo "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–æ–º–µ–Ω–∞:"
read -s ADMIN_PASS
echo "–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–æ–º–µ–Ω–∞:"
read -s ADMIN_PASS_CONFIRM

# üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π
if [ "$ADMIN_PASS" != "$ADMIN_PASS_CONFIRM" ]; then
    echo "‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!"
    exit 1
fi

# üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã –ø–∞—Ä–æ–ª—è
if [ ${#ADMIN_PASS} -lt 8 ]; then
    echo "‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤!"
    exit 1
fi

echo "‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–º–µ–Ω–∞ –ø—Ä–∏–Ω—è—Ç—ã"

# üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏–º–µ–Ω
echo "üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π–ª–∞ hosts..."
sed -i "/$DOMAIN/d" /etc/hosts
echo "127.0.0.1 $DOMAIN" >> /etc/hosts

# üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DNS
echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DNS resolver..."
systemctl stop systemd-resolved 2>/dev/null
systemctl disable systemd-resolved 2>/dev/null
rm -f /etc/resolv.conf
echo "nameserver 127.0.0.1" > /etc/resolv.conf
echo "search $DOMAIN" >> /etc/resolv.conf
# –ó–∞—â–∏—Ç–∞ —Ñ–∞–π–ª–∞ –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
chattr +i /etc/resolv.conf 2>/dev/null || true

# üèóÔ∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–º–µ–Ω–∞
echo "üèóÔ∏è –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–æ–º–µ–Ω–∞..."
echo "–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç..."

samba-tool domain provision \
    --use-rfc2307 \
    --realm=$DOMAIN \
    --domain=$NETBIOS_NAME \
    --server-role=dc \
    --dns-backend=SAMBA_INTERNAL \
    --adminpass=$ADMIN_PASS \
    --function-level=2008_R2

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–æ–º–µ–Ω–∞!"
    echo "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    exit 1
fi

echo "‚úÖ –î–æ–º–µ–Ω —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"

# üîê –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Kerberos
echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Kerberos..."
cp /var/lib/samba/private/krb5.conf /etc/krb5.conf

# üöÄ –ó–∞–ø—É—Å–∫ —Å–ª—É–∂–±
echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã Samba AD DC..."
systemctl unmask samba-ad-dc
systemctl enable samba-ad-dc
systemctl start samba-ad-dc

# ‚è±Ô∏è –î–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–ª—É–∂–±—ã
echo "‚è±Ô∏è –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–ª—É–∂–±..."
sleep 10

# üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–ª—É–∂–±—ã
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–ª—É–∂–±—ã Samba..."
if systemctl is-active --quiet samba-ad-dc; then
    echo "‚úÖ Samba AD DC —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ Samba AD DC"
    systemctl status samba-ad-dc
    exit 1
fi

# üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –¥–æ–º–µ–Ω–∞
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–æ–º–µ–Ω–∞..."
samba-tool domain level show

# üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS
echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è..."
nslookup $DOMAIN

# üîë –ü—Ä–æ–≤–µ—Ä–∫–∞ Kerberos
echo "üîë –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Kerberos..."
if command -v kinit &> /dev/null; then
    echo "üîë –ü–æ–ª—É—á–µ–Ω–∏–µ Kerberos-–±–∏–ª–µ—Ç–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞..."
    kinit administrator@$DOMAIN << EOF
$ADMIN_PASS
EOF
    if [ $? -eq 0 ]; then
        echo "‚úÖ Kerberos-–±–∏–ª–µ—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω"
        klist
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è Kerberos-–±–∏–ª–µ—Ç–∞"
    fi
else
    echo "‚ö†Ô∏è kinit –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É Kerberos"
fi

# üéä –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
echo ""
echo "=================================================="
echo "üéâ –£–°–¢–ê–ù–û–í–ö–ê –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–ê!"
echo "=================================================="
echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–º–µ–Ω–µ:"
echo "   üåê –î–æ–º–µ–Ω: $DOMAIN"
echo "   üíª NetBIOS-–∏–º—è: $NETBIOS_NAME"
echo "   üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: administrator@$DOMAIN"
echo ""
echo "üîß –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–º–µ–Ω–æ–º:"
echo "   üë• samba-tool user list          - —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
echo "   üë®‚Äçüë©‚Äçüëß‚Äçüë¶ samba-tool group list         - —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø" 
echo "   üìä samba-tool domain level show  - —É—Ä–æ–≤–µ–Ω—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏"
echo "   ‚ûï samba-tool user create <user> - —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
echo "   üîÑ samba-tool domain info <IP>   - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–º–µ–Ω–µ"
echo ""
echo "‚ö†Ô∏è  –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è:"
echo "   ‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Ä–µ–º—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ NTP)"
echo "   ‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±—Ä–∞–Ω–¥–º–∞—É—ç—Ä –¥–ª—è –ø–æ—Ä—Ç–æ–≤ 53, 88, 135, 139, 389, 445"
echo "   ‚Ä¢ –î–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ —É–∫–∞–∂–∏—Ç–µ DNS-—Å–µ—Ä–≤–µ—Ä —ç—Ç–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –¥–æ–º–µ–Ω–∞"
echo "=================================================="