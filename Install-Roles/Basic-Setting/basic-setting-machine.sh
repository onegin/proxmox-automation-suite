#!/bin/bash

# ======================================================================
# ğŸ§ Debian Basic-Setting script
# ======================================================================
# 
# ğŸ‘¨â€ğŸ’» ĞĞ²Ñ‚Ğ¾Ñ€: ĞĞ½Ñ‚Ğ¾Ğ½Ğ¾Ğ² Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹
# ğŸ“§ ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹: ae@dcea.ru
# 
# ğŸ“œ Ğ›Ğ˜Ğ¦Ğ•ĞĞ—Ğ˜Ğ¯:
# âœ… Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ½ĞµĞºĞ¾Ğ¼Ğ¼ĞµÑ€Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
# 
# ======================================================================

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
if [ "$EUID" -ne 0 ]; then
    echo "Ğ­Ñ‚Ğ¾Ñ‚ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ° ÑÑƒĞ¿ĞµÑ€Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ Ñ sudo."
    exit 1
fi

# ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¿Ğ¸ÑĞºĞ° Ğ¿Ğ°ĞºĞµÑ‚Ğ¾Ğ²
echo "ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¿Ğ¸ÑĞºĞ° Ğ¿Ğ°ĞºĞµÑ‚Ğ¾Ğ²..."
apt update

# ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ñ… Ğ¿Ğ°ĞºĞµÑ‚Ğ¾Ğ²
echo "ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹..."
apt upgrade -y

# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ğ°ĞºĞµÑ‚Ğ¾Ğ² (Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ locales, rsyslog, net-tools, tzdata, logrotate, screen)
echo "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ğ°ĞºĞµÑ‚Ğ¾Ğ²..."
apt install -y vim git wget curl mc unrar zip openssh-server htop iftop sudo zabbix-agent locales rsyslog net-tools tzdata logrotate screen

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾ĞºĞ°Ğ»Ğ¸
echo "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾ĞºĞ°Ğ»Ğ¸..."
sed -i 's/^# *\(en_US.UTF-8\)/\1/' /etc/locale.gen
locale-gen
update-locale LANG=en_US.UTF-8

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ñ‡Ğ°ÑĞ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾ÑÑĞ°
echo "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ñ‡Ğ°ÑĞ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾ÑÑĞ°..."
dpkg-reconfigure -f noninteractive tzdata

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° SSH - Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ root
echo "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° SSH..."
sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
systemctl restart ssh

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ¾Ğ² Ğ² ÑÑ‚Ğ¸Ğ»Ğµ eth
echo "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑĞµÑ‚ĞµĞ²Ñ‹Ñ… Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ¾Ğ²..."
# Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ´Ğ»Ñ udev
cat > /etc/udev/rules.d/70-persistent-net.rules << 'EOF'
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="?*", ATTR{dev_id}=="0x0", ATTR{type}=="1", NAME="eth0"
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="?*", ATTR{dev_id}=="0x0", ATTR{type}=="1", NAME="eth1"
EOF

# Ğ¢Ğ°ĞºĞ¶Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼ grub Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
if ! grep -q "net.ifnames=0" /etc/default/grub; then
    sed -i 's/GRUB_CMDLINE_LINUX=""/GRUB_CMDLINE_LINUX="net.ifnames=0 biosdevname=0"/' /etc/default/grub
    update-grub
fi

# Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
read -p "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: " username
read -sp "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: " password
echo

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
echo "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ $username..."
adduser --disabled-password --gecos "" $username

# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
echo "$username:$password" | chpasswd

# Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ sudo
usermod -aG sudo $username

# ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº ÑĞ»ÑƒĞ¶Ğ±
echo "ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… ÑĞ»ÑƒĞ¶Ğ±..."
systemctl restart rsyslog

echo "=================================================="
echo "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°!"
echo "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ $username Ñ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸ sudo"
echo "Root Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¿Ğ¾ SSH Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½"
echo "Ğ¡ĞµÑ‚ĞµĞ²Ñ‹Ğµ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑÑ‹ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ² ÑÑ‚Ğ¸Ğ»Ğµ eth0, eth1 Ğ¸ Ñ‚.Ğ´."
echo "Ğ”Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ²ÑĞµÑ… Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ"
echo "=================================================="